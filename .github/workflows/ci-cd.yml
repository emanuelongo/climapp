services:
  postgres:
    image: postgres:15
    ports:
      - 5432:5432
    env:
      POSTGRES_USER: climapp_user
      POSTGRES_PASSWORD: climapp_pass
      POSTGRES_DB: climapp_user
    options: >-
      --health-cmd="pg_isready -U climapp_user -d climapp_user"
      --health-interval=10s
      --health-timeout=5s
      --health-retries=5

steps:
  - name: Checkout repository
    uses: actions/checkout@v4

  # === FRONTEND ===
  - name: Set up Node.js
    uses: actions/setup-node@v4
    with:
      node-version: '20'

  - name: Install frontend dependencies
    working-directory: ./frontend/climapp
    run: npm install

  - name: Build frontend
    working-directory: ./frontend/climapp
    run: npm run build

  # === BACKEND ===
  - name: Set up Python
    uses: actions/setup-python@v5
    with:
      python-version: '3.11'

  - name: Install backend dependencies
    working-directory: ./backend
    run: |
      pip install -r requirements.txt
      pip install requests pytest uvicorn

  - name: Wait for PostgreSQL
    run: |
      until pg_isready -h localhost -p 5432 -U climapp_user -d climapp_user; do
        echo "Esperando a que PostgreSQL estÃ© listo..."
        sleep 3
      done

  - name: Start backend server
    working-directory: ./backend
    env:
      DATABASE_URL: postgresql://climapp_user:climapp_pass@localhost:5432/climapp_user
    run: |
      nohup uvicorn app.main:app --host 0.0.0.0 --port 8090 &
      sleep 10

  - name: Run tests
    working-directory: ./backend
    env:
      DATABASE_URL: postgresql://climapp_user:climapp_pass@localhost:5432/climapp_user
    run: python test_favoritos.py

  # === DOCKER ===
  - name: Determine image name
    id: image
    run: |
      if [ -z "${{ secrets.DOCKERHUB_USERNAME }}" ]; then
        echo "image_name=${{ github.repository_owner }}/backend:latest" >> $GITHUB_OUTPUT
      else
        echo "image_name=${{ secrets.DOCKERHUB_USERNAME }}/backend:latest" >> $GITHUB_OUTPUT
      fi

  - name: Build Docker image
    run: docker build -t ${{ steps.image.outputs.image_name }} ./backend

  - name: Login to DockerHub (only if secrets present)
    if: ${{ secrets.DOCKERHUB_USERNAME != '' && secrets.DOCKERHUB_TOKEN != '' }}
    run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

  - name: Push Docker image (only if secrets present)
    if: ${{ secrets.DOCKERHUB_USERNAME != '' && secrets.DOCKERHUB_TOKEN != '' }}
    run: docker push ${{ steps.image.outputs.image_name }}
